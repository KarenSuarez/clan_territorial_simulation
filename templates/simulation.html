{% extends 'base.html' %}

{% block title %}Simulación en Tiempo Real{% endblock %}

{% block head %}
<meta name="description" content="Visualización interactiva de la simulación de competencia territorial">
<style>
    .simulation-intro {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        text-align: center;
    }

    .simulation-intro h3 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
    }

    .simulation-intro p {
        margin: 0;
        opacity: 0.9;
        line-height: 1.6;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: white;
    }

    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .clan-metric {
        background: white;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .clan-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .clan-name {
        font-weight: bold;
        color: var(--primary-color);
    }

    .connection-status {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .connection-status.connected {
        background: var(--success-color);
        color: white;
    }

    .connection-status.disconnected {
        background: var(--accent-color);
        color: white;
    }

    .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-top: 1rem;
    }

    .notification {
        font-family: inherit;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .breadcrumb {
        margin-bottom: 1rem;
    }

    .breadcrumb ol {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .breadcrumb li {
        color: var(--dark-gray);
    }

    .breadcrumb li:not(:last-child)::after {
        content: '>';
        margin-left: 0.5rem;
        color: var(--secondary-color);
    }

    .breadcrumb a {
        color: var(--secondary-color);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    /* Estilos para configuración WebSocket mejorada */
    .connection-indicator {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .connection-status.connected {
        color: #27ae60;
    }

    .connection-status.disconnected {
        color: #e74c3c;
    }

    .config-form-inner {
        /* Evitar que el formulario haga submit tradicional */
    }

    #applyConfigBtn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .current-config-info {
        transition: all 0.3s ease;
    }

    .current-config-info.updated {
        background: #d5f4e6 !important;
        border-left-color: #27ae60 !important;
    }

    /* Indicador de carga en el botón */
    .loading-button {
        position: relative;
        pointer-events: none;
    }

    .loading-button::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }

    /* Estilos adicionales para los controles de finalización */
    .simulation-progress {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid #3498db;
    }

    .simulation-progress .progress-bar {
        background: linear-gradient(90deg, #27ae60, #3498db);
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    #terminationInfo {
        background: #f8f9fa;
        padding: 0.8rem;
        border-radius: 4px;
        border-left: 3px solid #3498db;
        margin-top: 0.5rem;
    }

    .controls-section input[type="number"] {
        font-family: monospace;
        text-align: center;
    }

    .controls-section input[type="checkbox"] {
        accent-color: #27ae60;
    }

    .parameter-panel {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        width: 420px;
        max-height: 90vh;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px 0 0 8px;
        box-shadow: -4px 0 20px rgba(0,0,0,0.15);
        z-index: 1000;
        transition: transform 0.3s ease;
        overflow: hidden;
        font-size: 0.9rem;
    }

    /* Modificación: Cuando el panel está colapsado */
    .parameter-panel.collapsed {
        transform: translateY(-50%) translateX(380px); /* Ajusta este valor si el ancho del panel cambia */
    }

    /* NUEVO: Botón redondo y más bonito */
    .parameter-toggle-btn {
    position: absolute;
    left: -60px; /* PRUEBA ESTO: Antes -120px; ahora justo al borde del panel */
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    box-shadow: -4px 0 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    z-index: 1001; /* Asegura que esté por encima del panel */
}

    .parameter-toggle-btn:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: -6px 0 20px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }

    .parameter-toggle-btn:active {
        transform: translateY(-50%) scale(0.95);
    }

    /* El botón no necesita cambiar de posición cuando el panel está colapsado, ya que el panel se mueve */
    .parameter-panel.collapsed .parameter-toggle-btn {
        left: 0px;
    }

    .toggle-icon {
        font-size: 1.2rem;
        margin-bottom: 0.2rem;
        transition: transform 0.3s ease;
    }

    .toggle-text {
        font-size: 0.6rem;
        text-align: center;
        line-height: 1;
        opacity: 0.9;
    }

    /* Gira el icono cuando el panel está colapsado */
    .parameter-panel.collapsed .toggle-icon {
        transform: rotate(180deg);
    }

    .parameter-content {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .parameter-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
    }

    .parameter-header h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        color: var(--primary-color);
    }

    .parameter-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .parameter-status {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #e8f5e8;
        border-bottom: 1px solid #ddd;
        font-size: 0.85rem;
    }

    .parameter-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-size: 0.8rem;
        white-space: nowrap;
        transition: all 0.2s ease;
        color: black;
        min-width: 80px;
    }

    .tab-btn:hover {
        background: #e9ecef;
    }

    .tab-btn.active {
        background: white;
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: 600;
    }

    .parameter-sections {
        flex: 1 1 auto;
        min-height: 0;
        max-height: 55vh; /* Ajusta si el contenido es demasiado largo */
        overflow-y: auto;
        padding: 1rem;
    }

    .parameter-section {
        display: none;
    }

    .parameter-section.active {
        display: block;
    }

    .parameter-section h4 {
        margin: 0 0 1rem 0;
        color: var(--primary-color);
        font-size: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #eee;
    }

    .param-group {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid var(--secondary-color);
    }

    .param-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--dark-gray);
    }

    .param-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .param-control input[type="range"] {
        flex: 1;
        min-width: 0;
    }

    .param-control input[type="number"] {
        width: 80px;
        padding: 0.25rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .param-unit {
        font-size: 0.8rem;
        color: #666;
        min-width: 60px;
    }

    .param-group small {
        display: block;
        color: #666;
        font-style: italic;
        line-height: 1.3;
    }

    .parameter-footer {
        padding: 1rem;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }

    .apply-options {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.85rem;
    }

    .apply-options label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .param-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .param-btn-primary { background: var(--primary-color); color: white; }
    .param-btn-success { background: var(--success-color); color: white; }
    .param-btn-warning { background: var(--warning-color); color: white; }

    .param-btn:hover {
        transform: translateY(-1px);
        opacity: 0.9;
    }

    .param-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    #presetSelector {
        padding: 0.25rem 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.8rem;
        max-width: 150px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .parameter-panel {
            width: 380px;
        }
        
        .parameter-panel.collapsed {
            transform: translateY(-50%) translateX(340px);
        }
    }

    @media (max-width: 768px) {
        .parameter-panel {
            width: 100vw;
            height: 100vh;
            top: 0;
            right: 0;
            transform: none;
            border-radius: 0;
            max-height: none;
        }
        
        .parameter-panel.collapsed {
            transform: translateX(100%);
        }
        
        .parameter-toggle-btn {
            left: -50px;
            top: 20px;
            transform: none;
            border-radius: 8px 0 0 8px;
        }
        
        .param-control {
            flex-direction: column;
            align-items: stretch;
            gap: 0.25rem;
        }
        
        .param-control input[type="number"] {
            width: 100%;
        }
    }

    /* Animaciones para cambios */
    .param-group.changed {
        border-left-color: var(--warning-color);
        animation: parameterChanged 0.5s ease;
    }

    @keyframes parameterChanged {
        0% { background: #fff3cd; }
        100% { background: #f8f9fa; }
    }

    .status-indicator.applying {
        color: var(--warning-color);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* NUEVOS ESTILOS PARA LA SECCIÓN DE REJILLA */
    .grid-control {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .grid-control .param-group {
        margin-bottom: 0;
    }

    .grid-preview {
        background: #e9ecef;
        border-radius: 4px;
        padding: 1rem;
        text-align: center;
        margin-top: 1rem;
        border: 2px dashed #adb5bd;
    }

    .grid-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }

    .grid-info div {
        background: white;
        padding: 0.5rem;
        border-radius: 4px;
        text-align: center;
    }

    .apply-grid-btn {
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    .apply-grid-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .apply-grid-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="simulation-intro">
    <h3>🎮 Simulación Interactiva de Competencia Territorial</h3>
    <p>
        Observa cómo los clanes compiten por territorio y recursos en tiempo real.
        Configura los parámetros, controla la velocidad y analiza las dinámicas emergentes
        del sistema de supervivencia colectiva.
    </p>
</div>

<div class="config-form">
    <h3>⚙️ Configuración de la Simulación</h3>
    
    <div class="connection-indicator" style="margin-bottom: 1rem; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
        <span id="connectionIndicator" class="connection-status disconnected">🔴 Desconectado</span>
        <span style="margin-left: 1rem; color: #666;">Estado del WebSocket</span>
    </div>

    <form class="config-form-inner" onsubmit="return false;">
        <div class="form-row">
            <div class="form-group">
                <label for="simulation_mode">
                    🎲 Modo de Simulación
                    <span class="info-tooltip"
                        data-tooltip="Determinista: resultados reproducibles con semilla. Estocástico: variabilidad aleatoria en cada ejecución.">?</span>
                </label>
                <select name="simulation_mode" id="simulation_mode" required>
                    <option value="stochastic" {% if current_mode=='stochastic' %}selected{% endif %}>
                        🎯 Estocástico (Aleatorio)
                    </option>
                    <option value="deterministic" {% if current_mode=='deterministic' %}selected{% endif %}>
                        🔧 Determinista (Reproducible)
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="config_file">
                    📋 Configuración Predefinida
                    <span class="info-tooltip"
                        data-tooltip="Selecciona una configuración con parámetros específicos para diferentes escenarios de simulación.">?</span>
                </label>
                <select name="config_file" id="config_file" required>
                    {% for config in config_files %}
                    <option value="{{ config }}" {% if request.form.get('config_file')==config or (not request.form and config=='stochastic_default') %}selected{% endif %}>
                        📄 {{ config.replace('_', ' ').title() }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="seed">
                    🌱 Semilla (Solo modo determinista)
                    <span class="info-tooltip"
                        data-tooltip="Número para generar resultados reproducibles. Déjalo vacío para usar semilla aleatoria.">?</span>
                </label>
                <input type="number" name="seed" id="seed" placeholder="Ej: 12345" min="1" max="999999" 
                        value="{{ initial_seed if initial_seed is not none else '' }}">
            </div>

            <div class="form-group">
                <button type="button" onclick="applyConfigurationViaSocket()" class="play-btn" id="applyConfigBtn">
                    🚀 Aplicar Configuración
                </button>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                    ⚡ La configuración se aplica sin recargar la página
                </div>
            </div>
        </div>
    </form>

    <div id="parameterEditorPanel" class="parameter-panel collapsed">
        <button id="parameterToggleBtn" class="parameter-toggle-btn" onclick="toggleParameterPanel()">
            <span class="toggle-icon">⚙️</span>
            <span class="toggle-text">Parámetros</span>
        </button>
        
        <div class="parameter-content">
            <div class="parameter-header">
                <h3>🔧 Editor de Parámetros en Vivo</h3>
                <div class="parameter-actions">
                    <button onclick="resetToDefaults()" class="param-btn param-btn-warning">
                        🔄 Restablecer
                    </button>
                    <button onclick="savePreset()" class="param-btn param-btn-success">
                        💾 Guardar Preset
                    </button>
                    <select id="presetSelector" onchange="loadPreset(this.value)">
                        <option value="">-- Cargar Preset --</option>
                        <option value="aggressive">🔥 Agresivo</option>
                        <option value="cooperative">🤝 Cooperativo</option>
                        <option value="survival">💀 Supervivencia</option>
                        <option value="rapid_growth">📈 Crecimiento Rápido</option>
                    </select>
                </div>
            </div>
            
            <div id="parameterStatus" class="parameter-status">
                <span class="status-indicator">🟢</span>
                <span class="status-text">Listo para aplicar cambios</span>
            </div>
            
            <div class="parameter-tabs">
                <button class="tab-btn active" onclick="showTab('population')">👥 Población</button>
                <button class="tab-btn" onclick="showTab('resources')">🌿 Recursos</button>
                <button class="tab-btn" onclick="showTab('behavior')">🧠 Comportamiento</button>
                <button class="tab-btn" onclick="showTab('combat')">⚔️ Combate</button>
                <button class="tab-btn" onclick="showTab('environment')">🌍 Entorno</button>
                <button class="tab-btn" onclick="showTab('grid')">📐 Rejilla</button>
            </div>
            
            <div class="parameter-sections">
                
                <div id="population-tab" class="parameter-section active">
                    <h4>👥 Parámetros Demográficos</h4>
                    
                    <div class="param-group">
                        <label for="birthRate">Tasa de Natalidad</label>
                        <div class="param-control">
                            <input type="range" id="birthRate" min="0" max="0.5" step="0.01" value="0.1">
                            <input type="number" id="birthRateNum" min="0" max="0.5" step="0.01" value="0.1">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Velocidad de reproducción de los clanes</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="deathRate">Tasa de Mortalidad Natural</label>
                        <div class="param-control">
                            <input type="range" id="deathRate" min="0" max="0.2" step="0.01" value="0.05">
                            <input type="number" id="deathRateNum" min="0" max="0.2" step="0.01" value="0.05">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Mortalidad base sin considerar inanición</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="starvationMortality">Mortalidad por Inanición</label>
                        <div class="param-control">
                            <input type="range" id="starvationMortality" min="0" max="1" step="0.05" value="0.8">
                            <input type="number" id="starvationMortalityNum" min="0" max="1" step="0.05" value="0.8">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Intensidad de la mortalidad cuando no hay energía</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="energyDecay">Degradación de Energía</label>
                        <div class="param-control">
                            <input type="range" id="energyDecay" min="1" max="10" step="0.5" value="3">
                            <input type="number" id="energyDecayNum" min="1" max="10" step="0.5" value="3">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Velocidad de pérdida de energía por el tiempo</small>
                    </div>
                </div>
                
                <div id="resources-tab" class="parameter-section">
                    <h4>🌿 Gestión de Recursos</h4>
                    
                    <div class="param-group">
                        <label for="resourceRegen">Regeneración de Recursos</label>
                        <div class="param-control">
                            <input type="range" id="resourceRegen" min="0.1" max="5" step="0.1" value="1.5">
                            <input type="number" id="resourceRegenNum" min="0.1" max="5" step="0.1" value="1.5">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Velocidad de regeneración natural de recursos</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="resourceRequired">Recursos por Individuo</label>
                        <div class="param-control">
                            <input type="range" id="resourceRequired" min="0.1" max="3" step="0.1" value="1.2">
                            <input type="number" id="resourceRequiredNum" min="0.1" max="3" step="0.1" value="1.2">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Cantidad de recursos que necesita cada individuo</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="energyConversion">Eficiencia de Conversión</label>
                        <div class="param-control">
                            <input type="range" id="energyConversion" min="5" max="30" step="1" value="15">
                            <input type="number" id="energyConversionNum" min="5" max="30" step="1" value="15">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Eficiencia para convertir recursos en energía</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="resourceMax">Capacidad Máxima por Celda</label>
                        <div class="param-control">
                            <input type="range" id="resourceMax" min="50" max="200" step="10" value="100">
                            <input type="number" id="resourceMaxNum" min="50" max="200" step="10" value="100">
                            <span class="param-unit">unidades</span>
                        </div>
                        <small>Cantidad máxima de recursos por celda del mapa</small>
                    </div>
                </div>
                
                <div id="behavior-tab" class="parameter-section">
                    <h4>🧠 Parámetros de Comportamiento</h4>
                    
                    <div class="param-group">
                        <label for="cooperation">Tendencia Cooperativa</label>
                        <div class="param-control">
                            <input type="range" id="cooperation" min="0" max="1" step="0.05" value="0.6">
                            <input type="number" id="cooperationNum" min="0" max="1" step="0.05" value="0.6">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Probabilidad de formar alianzas y cooperar</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="aggressiveness">Agresividad</label>
                        <div class="param-control">
                            <input type="range" id="aggressiveness" min="0" max="1" step="0.05" value="0.3">
                            <input type="number" id="aggressivenessNum" min="0" max="1" step="0.05" value="0.3">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Tendencia a iniciar combates y ser territorial</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="movementSpeed">Velocidad de Movimiento</label>
                        <div class="param-control">
                            <input type="range" id="movementSpeed" min="0.5" max="3" step="0.1" value="1">
                            <input type="number" id="movementSpeedNum" min="0.5" max="3" step="0.1" value="1">
                            <span class="param-unit">celdas/dt</span>
                        </div>
                        <small>Velocidad base de movimiento de los clanes</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="perceptionRadius">Radio de Percepción</label>
                        <div class="param-control">
                            <input type="range" id="perceptionRadius" min="2" max="10" step="1" value="5">
                            <input type="number" id="perceptionRadiusNum" min="2" max="10" step="1" value="5">
                            <span class="param-unit">celdas</span>
                        </div>
                        <small>Distancia a la que los clanes detectan recursos y enemigos</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="territorialExpansion">Expansión Territorial</label>
                        <div class="param-control">
                            <input type="range" id="territorialExpansion" min="0" max="0.2" step="0.01" value="0.05">
                            <input type="number" id="territorialExpansionNum" min="0" max="0.2" step="0.01" value="0.05">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Velocidad de expansión del territorio controlado</small>
                    </div>
                </div>
                
                <div id="combat-tab" class="parameter-section">
                    <h4>⚔️ Parámetros de Combate</h4>
                    
                    <div class="param-group">
                        <label for="combatRadius">Radio de Combate</label>
                        <div class="param-control">
                            <input type="range" id="combatRadius" min="1" max="8" step="0.5" value="5">
                            <input type="number" id="combatRadiusNum" min="1" max="8" step="0.5" value="5">
                            <span class="param-unit">celdas</span>
                        </div>
                        <small>Distancia máxima para iniciar combate</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="combatDamage">Factor de Daño</label>
                        <div class="param-control">
                            <input type="range" id="combatDamage" min="1" max="10" step="0.5" value="5">
                            <input type="number" id="combatDamageNum" min="1" max="10" step="0.5" value="5">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Intensidad del daño en combate</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="combatEnergyCost">Costo Energético</label>
                        <div class="param-control">
                            <input type="range" id="combatEnergyCost" min="5" max="40" step="5" value="20">
                            <input type="number" id="combatEnergyCostNum" min="5" max="40" step="5" value="20">
                            <span class="param-unit">por dt</span>
                        </div>
                        <small>Energía gastada por combatir</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="allianceProbability">Probabilidad de Alianza</label>
                        <div class="param-control">
                            <input type="range" id="allianceProbability" min="0" max="0.5" step="0.05" value="0.2">
                            <input type="number" id="allianceProbabilityNum" min="0" max="0.5" step="0.05" value="0.2">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Probabilidad de formar alianzas entre clanes</small>
                    </div>
                </div>
                
                <div id="environment-tab" class="parameter-section">
                    <h4>🌍 Parámetros del Entorno</h4>
                    
                    <div class="param-group">
                        <label for="interactionRadius">Radio de Interacción</label>
                        <div class="param-control">
                            <input type="range" id="interactionRadius" min="2" max="10" step="0.5" value="5">
                            <input type="number" id="interactionRadiusNum" min="2" max="10" step="0.5" value="5">
                            <span class="param-unit">celdas</span>
                        </div>
                        <small>Distancia para interacciones sociales entre clanes</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="migrationThreshold">Umbral de Migración</label>
                        <div class="param-control">
                            <input type="range" id="migrationThreshold" min="5" max="25" step="1" value="10">
                            <input type="number" id="migrationThresholdNum" min="5" max="25" step="1" value="10">
                            <span class="param-unit">factor</span>
                        </div>
                        <small>Multiplicador de recursos necesarios para triggear migración</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="restingThreshold">Umbral de Descanso</label>
                        <div class="param-control">
                            <input type="range" id="restingThreshold" min="10" max="50" step="5" value="25">
                            <input type="number" id="restingThresholdNum" min="10" max="50" step="5" value="25">
                            <span class="param-unit">% energía</span>
                        </div>
                        <small>Nivel de energía bajo el cual los clanes descansan</small>
                    </div>
                    
                    <div class="param-group">
                        <label for="fightingThreshold">Umbral de Combate</label>
                        <div class="param-control">
                            <input type="range" id="fightingThreshold" min="15" max="60" step="5" value="30">
                            <input type="number" id="fightingThresholdNum" min="15" max="60" step="5" value="30">
                            <span class="param-unit">% energía</span>
                        </div>
                        <small>Energía mínima necesaria para iniciar combate</small>
                    </div>
                </div>

                <div id="grid-tab" class="parameter-section">
                    <h4>📐 Configuración de la Rejilla</h4>
                    
                    <div class="grid-control">
                        <div class="param-group">
                            <label for="gridWidth">Ancho de la Rejilla</label>
                            <div class="param-control">
                                <input type="range" id="gridWidth" min="10" max="200" step="5" value="50">
                                <input type="number" id="gridWidthNum" min="10" max="200" step="5" value="50">
                                <span class="param-unit">celdas</span>
                            </div>
                            <small>Número de celdas horizontales</small>
                        </div>
                        
                        <div class="param-group">
                            <label for="gridHeight">Alto de la Rejilla</label>
                            <div class="param-control">
                                <input type="range" id="gridHeight" min="10" max="200" step="5" value="50">
                                <input type="number" id="gridHeightNum" min="10" max="200" step="5" value="50">
                                <span class="param-unit">celdas</span>
                            </div>
                            <small>Número de celdas verticales</small>
                        </div>
                    </div>

                    <div class="grid-preview">
                        <strong>🔍 Vista Previa</strong>
                        <div id="gridPreviewInfo" style="margin-top: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                            50 × 50 celdas
                        </div>
                        
                        <div class="grid-info">
                            <div>
                                <strong>📊 Total de Celdas</strong><br>
                                <span id="totalCells">2,500</span>
                            </div>
                            <div>
                                <strong>🎯 Densidad Sugerida</strong><br>
                                <span id="suggestedDensity">Media</span>
                            </div>
                            <div>
                                <strong>⚡ Rendimiento</strong><br>
                                <span id="performanceIndicator">Óptimo</span>
                            </div>
                            <div>
                                <strong>🏛️ Clanes Máximos</strong><br>
                                <span id="maxClansRecommended">8-12</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="applyGridSize()" class="apply-grid-btn" id="applyGridBtn">
                        🚀 Aplicar Nuevo Tamaño de Rejilla
                    </button>
                    
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107; font-size: 0.85rem;">
                        <strong>⚠️ Nota importante:</strong> Cambiar el tamaño de la rejilla reiniciará la simulación completamente.
                        Los clanes serán reposicionados y los recursos regenerados.
                    </div>
                </div>
            </div>
            
            <div class="parameter-footer">
                <div class="apply-options">
                    <label>
                        <input type="checkbox" id="autoApply" checked>
                        🔄 Aplicar automáticamente
                    </label>
                    <label>
                        <input type="checkbox" id="applyToExisting">
                        ⚡ Aplicar a clanes existentes
                    </label>
                </div>
                <div class="action-buttons">
                    <button onclick="applyParameters()" class="param-btn param-btn-primary" id="applyBtn">
                        ✅ Aplicar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="current-config-info" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #3498db;">
        <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">📊 Configuración Actual</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
            <div>
                <strong>Modo:</strong> <span id="currentMode">{{ current_mode }}</span>
            </div>
            <div>
                <strong>Configuración:</strong> <span id="currentConfig">-</span>
            </div>
            <div>
                <strong>Semilla:</strong> <span id="currentSeed">{{ initial_seed if initial_seed is not none else 'Aleatoria' }}</span>
            </div>
            <div>
                <strong>Rejilla:</strong> <span id="currentGridSize">50×50</span>
            </div>
        </div>
    </div>
</div>

<div class="simulation-container">
    <div class="canvas-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">🗺️ Mapa de Simulación</h3>
            <div style="font-size: 0.9rem; color: var(--dark-gray);">
                <span id="statusIndicator" class="status-indicator status-stopped"></span>
                Estado: <span id="simulationStatus">Detenido</span>
            </div>
        </div>

        <canvas id="gridCanvas" width="600" height="400"></canvas>

        <div style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: var(--dark-gray);">
            💡 <strong>Tip:</strong> Haz clic en cualquier celda para ver información detallada
        </div>
    </div>

    <div class="controls-panel">
        <div class="controls-section">
            <h4>🎮 Controles de Simulación</h4>

            <div class="button-group">
                <button id="playButton" class="play-btn" title="Iniciar simulación (Espacio)">
                    ▶️ Iniciar
                </button>
                <button id="pauseButton" title="Pausar simulación (Espacio)">
                    ⏸️ Pausar
                </button>
                <button id="resetButton" class="danger-btn" title="Reiniciar simulación (R)">
                    🔄 Reiniciar
                </button>
                <button id="stepButton" title="Avanzar un paso (S)">
                    ⏭️ Paso
                </button>
            </div>

            <div class="speed-control">
                <label for="speedSlider">
                    ⚡ Velocidad de Simulación
                    <span class="info-tooltip"
                        data-tooltip="Controla qué tan rápido avanza la simulación. Mayor velocidad = menos tiempo entre pasos.">?</span>
                </label>
                <input type="range" id="speedSlider" class="speed-slider" min="1" max="200" value="100">
                <span id="speedValue" class="speed-value">1.0x</span>
            </div>

            <div style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="autoReset">
                    🔄 Auto-reiniciar cuando no queden clanes
                </label>
            </div>
        </div>

        <div class="controls-section">
            <h4>📊 Métricas en Tiempo Real</h4>

            <div class="metrics">
                <div class="metric-item">
                    <span class="metric-label">👥 Población Total:</span>
                    <span class="metric-value" id="population">0</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">🌿 Recursos Totales:</span>
                    <span class="metric-value" id="totalResource">0.00</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">🎯 Modo:</span>
                    <span class="metric-value" id="modeDisplay">{{ current_mode }}</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">🔢 Pasos:</span>
                    <span class="metric-value" id="stepCount">0</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">⏱️ Tiempo:</span>
                    <span class="metric-value" id="timeElapsed">00:00</span>
                </div>
            </div>
        </div>

        <div class="controls-section">
            <h4>🏛️ Información de Clanes</h4>
            <div id="clanMetrics">
                <p style="text-align: center; color: var(--dark-gray); font-style: italic;">
                    Inicia la simulación para ver estadísticas de clanes
                </p>
            </div>
        </div>

        <div class="controls-section">
            <h4>⏹️ Control de Finalización</h4>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="autoReset" checked style="transform: scale(1.2);">
                    🔄 Auto-reiniciar cuando termine
                </label>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="maxStepsInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                    📊 Máximo de pasos:
                </label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="number" id="maxStepsInput" min="50" max="2000" value="500"
                        style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="updateMaxSteps()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ✅ Aplicar
                    </button>
                </div>
            </div>

            <div id="terminationInfo" style="font-size: 0.85rem; color: #666; line-height: 1.4;">
                <strong>Condiciones de finalización:</strong><br>
                • Extinción total (5 pasos sin población)<br>
                • Un solo clan superviviente<br>
                • Población crítica (≤5 individuos)<br>
                • Convergencia poblacional estable<br>
                • Límite máximo de pasos
            </div>
        </div>

        <div class="simulation-progress controls-section" style="display: none;">
            </div>

        <div class="controls-section">
            <h4>⚡ Acciones Rápidas</h4>

            <button onclick="window.location.href='/conservation_analysis'"
                style="width: 100%; margin-bottom: 0.5rem;">
                🔬 Análisis de Conservación
            </button>

            <button onclick="window.location.href='/convergence_analysis'"
                style="width: 100%; margin-bottom: 0.5rem;">
                📈 Análisis de Convergencia
            </button>

            <button onclick="exportCurrentData()" style="width: 100%; margin-bottom: 0.5rem;">
                💾 Exportar Datos Actuales
            </button>

            <button onclick="takeScreenshot()" style="width: 100%;">
                📸 Capturar Pantalla
            </button>
        </div>
    </div>
</div>

<div class="chart-container" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">📈 Evolución Temporal</h3>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="window.SimulationController.showTrendAnalysis()" 
                    style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;"
                    title="Mostrar análisis de tendencias">
                📊 Análisis
            </button>
            <button onclick="window.SimulationController.exportChartData()" 
                    style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;"
                    title="Exportar datos del gráfico">
                💾 Exportar
            </button>
            <button onclick="window.SimulationController.resetCharts()" 
                    style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;"
                    title="Limpiar gráfico">
                🧹 Limpiar
            </button>
        </div>
    </div>
    
    <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
        <canvas id="populationChart" style="display: block; box-sizing: border-box; height: 100%; width: 100%;"></canvas>
    </div>
    
    <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
        <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <strong>📊 Puntos de Datos</strong><br>
            <span id="chartDataPoints">0/100</span>
        </div>
        <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <strong>📈 Tendencia Poblacional</strong><br>
            <span id="populationTrend">-</span>
        </div>
        <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <strong>🌿 Tendencia de Recursos</strong><br>
            <span id="resourceTrend">-</span>
        </div>
        <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <strong>🔗 Correlación</strong><br>
            <span id="correlationValue">-</span>
        </div>
    </div>
</div>

<style>
.chart-container {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    /* IMPORTANTE: Evitar que el contenedor crezca */
    max-width: 100%;
    overflow: hidden;
}

.chart-container canvas {
    /* IMPORTANTE: Mantener el canvas en su contenedor */
    max-width: 100% !important;
    max-height: 300px !important;
}

/* Estilos para los botones del gráfico */
.chart-container button:hover {
    opacity: 0.8;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Responsive para pantallas pequeñas */
@media (max-width: 768px) {
    .chart-container {
        padding: 1rem;
    }
    
    .chart-container div[style*="grid-template-columns"] {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.8rem;
    }
}
</style>

<script>
// Script para actualizar información del gráfico en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    // Función para actualizar estadísticas del gráfico
    function updateChartStats() {
        if (!window.ChartController) return;
        
        try {
            const data = window.ChartController.getChartData();
            const analysis = window.ChartController.generateTrendAnalysis();
            
            // Actualizar número de puntos de datos
            const dataPointsElement = document.getElementById('chartDataPoints');
            if (dataPointsElement) {
                dataPointsElement.textContent = `${data.labels.length}/${data.maxDataPoints}`;
            }
            
            // Actualizar tendencias si hay suficientes datos
            if (analysis.status !== 'insufficient_data') {
                const populationTrendElement = document.getElementById('populationTrend');
                if (populationTrendElement) {
                    const trendEmoji = {
                        'increasing': '📈',
                        'decreasing': '📉',
                        'stable': '➡️'
                    };
                    populationTrendElement.textContent = 
                        (trendEmoji[analysis.population.trend] || '') + ' ' + 
                        analysis.population.trend.charAt(0).toUpperCase() + analysis.population.trend.slice(1);
                }
                
                const resourceTrendElement = document.getElementById('resourceTrend');
                if (resourceTrendElement) {
                    const trendEmoji = {
                        'increasing': '📈',
                        'decreasing': '📉',
                        'stable': '➡️'
                    };
                    resourceTrendElement.textContent = 
                        (trendEmoji[analysis.resources.trend] || '') + ' ' + 
                        analysis.resources.trend.charAt(0).toUpperCase() + analysis.resources.trend.slice(1);
                }
                
                const correlationElement = document.getElementById('correlationValue');
                if (correlationElement) {
                    const correlation = analysis.correlation;
                    const corrText = correlation > 0.7 ? 'Alta' : 
                                       correlation > 0.4 ? 'Media' : 
                                       correlation > 0.1 ? 'Baja' : 'Muy Baja';
                    correlationElement.textContent = `${corrText} (${correlation.toFixed(2)})`;
                }
            }
            
        } catch (error) {
            console.error('Error actualizando estadísticas del gráfico:', error);
        }
    }
    
    // Actualizar estadísticas cada 5 segundos
    setInterval(updateChartStats, 5000);
    
    console.log('✅ Sistema de estadísticas de gráfico inicializado');
});
</script>

<div class="analysis-section" style="margin-top: 2rem;">
    <h3>📚 Información del Sistema</h3>

    <div class="form-row">
        <div>
            <h4>🎯 Objetivo de la Simulación</h4>
            <p>
                Esta simulación modela la competencia territorial entre clanes que luchan por
                recursos limitados en un entorno compartido. Cada clan debe balancear el
                crecimiento poblacional con la sostenibilidad de los recursos disponibles.
            </p>
        </div>

        <div>
            <h4>🔬 Parámetros Clave</h4>
            <ul>
                <li><strong>Tamaño del clan:</strong> Determina la capacidad de competencia</li>
                <li><strong>Recursos:</strong> Necesarios para la supervivencia y crecimiento</li>
                <li><strong>Territorio:</strong> Área de influencia y control</li>
                <li><strong>Interacciones:</strong> Competencia y colaboración entre clanes</li>
            </ul>
        </div>

        <div>
            <h4>🎨 Visualización</h4>
            <ul>
                <li><strong>Verde:</strong> Densidad de recursos (más intenso = más recursos)</li>
                <li><strong>Formas de clanes:</strong> Diferentes especies con formas únicas</li>
                <li><strong>Áreas sombreadas:</strong> Influencia territorial</li>
                <li><strong>Números en clanes:</strong> Tamaño actual de población</li>
            </ul>
        </div>
    </div>
</div>

<div class="analysis-section">
    <h3>⚡ Información de Rendimiento</h3>
    <div id="performanceInfo" style="font-family: monospace; font-size: 0.9rem;">
        <div>FPS: <span id="fps">--</span></div>
        <div>Latencia WebSocket: <span id="latency">--</span>ms</div>
        <div>Memoria utilizada: <span id="memoryUsage">--</span>MB</div>
    </div>
</div>

<script>
// JavaScript adicional para mejorar la UX del formulario
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar estado de conexión
    function updateConnectionIndicator(connected) {
        const indicator = document.getElementById('connectionIndicator');
        const button = document.getElementById('applyConfigBtn');
        
        if (indicator) {
            indicator.textContent = connected ? '🟢 Conectado' : '🔴 Desconectado';
            indicator.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        if (button) {
            button.disabled = !connected;
            button.textContent = connected ? '🚀 Aplicar Configuración' : '❌ Sin Conexión';
        }
    }
    
    // Actualizar información de configuración actual
    function updateCurrentConfigInfo(config) {
        document.getElementById('currentMode').textContent = config.mode || '-';
        document.getElementById('currentConfig').textContent = config.config_file || '-';
        document.getElementById('currentSeed').textContent = config.seed || 'Aleatoria';
        
        // Efecto visual de actualización
        const infoDiv = document.querySelector('.current-config-info');
        infoDiv.classList.add('updated');
        setTimeout(() => infoDiv.classList.remove('updated'), 2000);
    }
    
    // Función para mostrar estado de carga en el botón
    window.setApplyButtonLoading = function(loading) {
        const button = document.getElementById('applyConfigBtn');
        if (button) {
            if (loading) {
                button.classList.add('loading-button');
                button.textContent = 'Aplicando...';
                button.disabled = true;
            } else {
                button.classList.remove('loading-button');
                button.textContent = '🚀 Aplicar Configuración';
                button.disabled = false;
            }
        }
    };
    
    // Exportar funciones para uso en simulation.js
    window.updateConnectionIndicator = updateConnectionIndicator;
    window.updateCurrentConfigInfo = updateCurrentConfigInfo;
    
    // Inicializar estado
    updateConnectionIndicator(false);
    
    // Mostrar/ocultar indicador de progreso según el estado
    const observer = new MutationObserver(function (mutations) {
        const progressDiv = document.querySelector('.simulation-progress');
        const isRunning = window.SimulationController && window.SimulationController.isRunning();

        if (progressDiv) {
            progressDiv.style.display = isRunning ? 'block' : 'none';
        }
    });

    // Observar cambios en el estado de la simulación
    const targetNode = document.querySelector('.controls-panel');
    if (targetNode) {
        observer.observe(targetNode, { childList: true, subtree: true });
    }

    // NUEVO: Configurar eventos para la rejilla
    setupGridControls();
});

// NUEVA FUNCIÓN: Configurar controles de rejilla
function setupGridControls() {
    // Sincronizar sliders con números para la rejilla
    const gridWidth = document.getElementById('gridWidth');
    const gridWidthNum = document.getElementById('gridWidthNum');
    const gridHeight = document.getElementById('gridHeight');
    const gridHeightNum = document.getElementById('gridHeightNum');

    if (gridWidth && gridWidthNum) {
        gridWidth.addEventListener('input', function() {
            gridWidthNum.value = this.value;
            updateGridPreview();
        });
        
        gridWidthNum.addEventListener('input', function() {
            gridWidth.value = this.value;
            updateGridPreview();
        });
    }

    if (gridHeight && gridHeightNum) {
        gridHeight.addEventListener('input', function() {
            gridHeightNum.value = this.value;
            updateGridPreview();
        });
        
        gridHeightNum.addEventListener('input', function() {
            gridHeight.value = this.value;
            updateGridPreview();
        });
    }

    // Inicializar vista previa
    updateGridPreview();
}

// NUEVA FUNCIÓN: Actualizar vista previa de rejilla
function updateGridPreview() {
    const width = parseInt(document.getElementById('gridWidth')?.value || 50);
    const height = parseInt(document.getElementById('gridHeight')?.value || 50);
    
    // Actualizar información de vista previa
    const previewInfo = document.getElementById('gridPreviewInfo');
    if (previewInfo) {
        previewInfo.textContent = `${width} × ${height} celdas`;
    }
    
    // Calcular métricas
    const totalCells = width * height;
    const totalCellsElement = document.getElementById('totalCells');
    if (totalCellsElement) {
        totalCellsElement.textContent = totalCells.toLocaleString();
    }
    
    // Densidad sugerida
    const densityElement = document.getElementById('suggestedDensity');
    if (densityElement) {
        let density = 'Media';
        if (totalCells < 1000) density = 'Alta';
        else if (totalCells > 5000) density = 'Baja';
        densityElement.textContent = density;
    }
    
    // Indicador de rendimiento
    const performanceElement = document.getElementById('performanceIndicator');
    if (performanceElement) {
        let performance = 'Óptimo';
        let color = '#27ae60';
        
        if (totalCells > 10000) {
            performance = 'Pesado';
            color = '#e74c3c';
        } else if (totalCells > 5000) {
            performance = 'Moderado';
            color = '#f39c12';
        }
        
        performanceElement.textContent = performance;
        performanceElement.style.color = color;
    }
    
    // Clanes máximos recomendados
    const maxClansElement = document.getElementById('maxClansRecommended');
    if (maxClansElement) {
        const maxClans = Math.floor(totalCells / 300); // Aproximadamente 1 clan por 300 celdas
        const minClans = Math.max(2, Math.floor(maxClans * 0.6));
        maxClansElement.textContent = `${minClans}-${Math.min(maxClans, 20)}`;
    }
}

// NUEVA FUNCIÓN: Aplicar nuevo tamaño de rejilla
function applyGridSize() {
    const width = parseInt(document.getElementById('gridWidth')?.value || 50);
    const height = parseInt(document.getElementById('gridHeight')?.value || 50);
    
    if (width < 10 || width > 200 || height < 10 || height > 200) {
        showNotification('Las dimensiones deben estar entre 10 y 200', 'error');
        return;
    }
    
    if (!window.socket || !window.socket.connected) {
        showNotification('No hay conexión con el servidor', 'error');
        return;
    }
    
    // Deshabilitar botón
    const button = document.getElementById('applyGridBtn');
    if (button) {
        button.disabled = true;
        button.textContent = '⏳ Aplicando...';
    }
    
    // Enviar al servidor
    window.socket.emit('update_grid_size', {
        gridWidth: width,
        gridHeight: height
    });
    
    console.log(`📐 Solicitando cambio de rejilla a ${width}x${height}`);
}

// Función para actualizar máximo de pasos
function updateMaxSteps() {
    const input = document.getElementById('maxStepsInput');
    if (input && window.SimulationController) {
        const newMaxSteps = parseInt(input.value);
        if (newMaxSteps >= 50 && newMaxSteps <= 2000) {
            window.SimulationController.setMaxSteps(newMaxSteps);
            showNotification(`Máximo de pasos establecido en ${newMaxSteps}`, 'success');
        } else {
            showNotification('El máximo de pasos debe estar entre 50 y 2000', 'error');
        }
    }
}

// Funciones adicionales para la página
function exportCurrentData() {
    if (window.SimulationController && window.SimulationController.getState()) {
        const data = {
            state: window.SimulationController.getState(),
            history: window.SimulationController.getHistory(),
            timestamp: new Date().toISOString(),
            config: {
                mode: document.getElementById('simulation_mode').value,
                config_file: document.getElementById('config_file').value,
                seed: document.getElementById('seed').value
            }
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `simulation_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } else {
        alert('No hay datos de simulación disponibles para exportar.');
    }
}

function takeScreenshot() {
    const canvas = document.getElementById('gridCanvas');
    if (canvas) {
        const link = document.createElement('a');
        link.download = `simulation_screenshot_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }
}

// NUEVA FUNCIÓN: Mostrar notificaciones
function showNotification(message, type = 'info', duration = 3000) {
    console.log(`📢 ${type.toUpperCase()}: ${message}`);

    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
    `;

    // Colores según tipo
    const colors = {
        success: '#27ae60',
        error: '#e74c3c',
        warning: '#f39c12',
        info: '#3498db'
    };
    notification.style.backgroundColor = colors[type] || colors.info;

    document.body.appendChild(notification);

    // Animar entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);

    // Animar salida y remover
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, duration);
}

// NUEVA FUNCIÓN: Toggle para el panel de parámetros
function toggleParameterPanel() {
    const panel = document.getElementById('parameterEditorPanel');
    const toggleBtn = document.getElementById('parameterToggleBtn');
    
    if (panel) {
        panel.classList.toggle('collapsed');
        // Cambiar texto y contenido del botón
        const iconSpan = toggleBtn.querySelector('.toggle-icon');
        const textSpan = toggleBtn.querySelector('.toggle-text');

        if (panel.classList.contains('collapsed')) {
            iconSpan.textContent = '◀️'; // O el icono que desees para "abrir"
            textSpan.textContent = 'Abrir Parámetros';
        } else {
            iconSpan.textContent = '⚙️'; // O el icono que desees para "cerrar"
            textSpan.textContent = 'Parámetros';
        }
    }
}

</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<script>
// Performance monitoring
let fpsCounter = 0;
let lastFpsTime = Date.now();

function updatePerformanceInfo() {
    fpsCounter++;
    const now = Date.now();

    if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = fpsCounter;
        fpsCounter = 0;
        lastFpsTime = now;
    }

    // Memory usage (if available)
    if (performance.memory) {
        const memUsed = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
        document.getElementById('memoryUsage').textContent = memUsed;
    }

    requestAnimationFrame(updatePerformanceInfo);
}

// Start performance monitoring
document.addEventListener('DOMContentLoaded', function () {
    updatePerformanceInfo();

    // Update simulation status display
    function updateSimulationStatus() {
        const statusDisplay = document.getElementById('simulationStatus');
        const isRunning = window.SimulationController ? window.SimulationController.isRunning() : false;

        if (statusDisplay) {
            statusDisplay.textContent = isRunning ? 'Ejecutando' : 'Detenido';
        }
    }

    setInterval(updateSimulationStatus, 1000);
});

// Auto-save configuration
document.getElementById('simulation_mode').addEventListener('change', function () {
    localStorage.setItem('sim_mode', this.value);
});

document.getElementById('config_file').addEventListener('change', function () {
    localStorage.setItem('sim_config', this.value);
});

// Restore saved configuration
document.addEventListener('DOMContentLoaded', function () {
    const savedMode = localStorage.getItem('sim_mode');
    const savedConfig = localStorage.getItem('sim_config');

    if (savedMode) {
        const modeSelect = document.getElementById('simulation_mode');
        if (modeSelect && modeSelect.querySelector(`option[value="${savedMode}"]`)) {
            modeSelect.value = savedMode;
        }
    }

    if (savedConfig) {
        const configSelect = document.getElementById('config_file');
        if (configSelect && configSelect.querySelector(`option[value="${savedConfig}"]`)) {
            configSelect.value = savedConfig;
        }
    }
});

</script>
{% endblock %}