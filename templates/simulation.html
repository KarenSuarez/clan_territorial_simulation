{% extends 'base.html' %}

{% block title %}Simulaci√≥n en Tiempo Real{% endblock %}

{% block head %}
<meta name="description" content="Visualizaci√≥n interactiva de la simulaci√≥n de competencia territorial">
<style>
    /* ... (Estilos que ya ten√≠as, no hay cambios aqu√≠. Aseg√∫rate de que el estilo de .config-form, etc., est√© incluido) ... */
    .simulation-intro {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        text-align: center;
    }

    .simulation-intro h3 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
    }

    .simulation-intro p {
        margin: 0;
        opacity: 0.9;
        line-height: 1.6;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: white;
    }

    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .clan-metric {
        background: white;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .clan-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .clan-name {
        font-weight: bold;
        color: var(--primary-color);
    }

    .connection-status {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .connection-status.connected {
        background: var(--success-color);
        color: white;
    }

    .connection-status.disconnected {
        background: var(--accent-color);
        color: white;
    }

    .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-top: 1rem;
    }

    .notification {
        font-family: inherit;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .breadcrumb {
        margin-bottom: 1rem;
    }

    .breadcrumb ol {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .breadcrumb li {
        color: var(--dark-gray);
    }

    .breadcrumb li:not(:last-child)::after {
        content: '>';
        margin-left: 0.5rem;
        color: var(--secondary-color);
    }

    .breadcrumb a {
        color: var(--secondary-color);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }
    /* NUEVO: Estilos para el formulario de configuraci√≥n */
    .config-form {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem; /* Espacio debajo del formulario */
        border-left: 5px solid var(--primary-color);
        animation: fadeIn 0.8s ease-out;
    }

    .config-form h3 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--dark-gray);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="text"] { /* A√±adir text si alguna vez se usa */
        padding: 0.8rem 1rem;
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        font-size: 1rem;
        width: 100%; /* Asegurar que ocupe todo el ancho disponible en su columna */
        box-sizing: border-box; /* Incluir padding y border en el ancho */
    }

    .form-group button {
        margin-top: auto; /* Empujar el bot√≥n hacia abajo para alinearlo */
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
    }

    .form-group button.play-btn {
        background: linear-gradient(45deg, var(--success-color), #28b463);
        color: white;
        box-shadow: var(--shadow-small);
    }

    .form-group button.play-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .info-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        font-size: 0.8em;
        color: var(--secondary-color);
        font-weight: normal;
    }

    .info-tooltip::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--dark-gray);
        color: white;
        padding: 0.5rem 0.8rem;
        border-radius: 5px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 10;
        pointer-events: none;
        font-size: 0.9rem;
    }

    .info-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="simulation-intro">
    <h3>üéÆ Simulaci√≥n Interactiva de Competencia Territorial</h3>
    <p>
        Observa c√≥mo los clanes compiten por territorio y recursos en tiempo real.
        Configura los par√°metros, controla la velocidad y analiza las din√°micas emergentes
        del sistema de supervivencia colectiva.
    </p>
</div>

<form id="configForm" class="config-form">
    <h3>‚öôÔ∏è Configuraci√≥n de la Simulaci√≥n</h3>

    <div class="form-row">
        <div class="form-group">
            <label for="simulation_mode">
                üé≤ Modo de Simulaci√≥n
                <span class="info-tooltip"
                    data-tooltip="Determinista: resultados reproducibles con semilla. Estoc√°stico: variabilidad aleatoria en cada ejecuci√≥n.">?</span>
            </label>
            <select name="simulation_mode" id="simulation_mode" required>
                <option value="stochastic" {% if current_mode=='stochastic' %}selected{% endif %}>
                    üéØ Estoc√°stico (Aleatorio)
                </option>
                <option value="deterministic" {% if current_mode=='deterministic' %}selected{% endif %}>
                    üîß Determinista (Reproducible)
                </option>
            </select>
        </div>

        <div class="form-group">
            <label for="config_file">
                üìã Configuraci√≥n Predefinida
                <span class="info-tooltip"
                    data-tooltip="Selecciona una configuraci√≥n con par√°metros espec√≠ficos para diferentes escenarios de simulaci√≥n.">?</span>
            </label>
            <select name="config_file" id="config_file" required>
                {% for config in config_files %}
                <option value="{{ config }}" {% if config=='stochastic_default' %}selected{% endif %}>
                    üìÑ {{ config.replace('_', ' ').title() }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="seed">
                üå± Semilla (Solo modo determinista)
                <span class="info-tooltip"
                    data-tooltip="N√∫mero para generar resultados reproducibles. D√©jalo vac√≠o para usar semilla aleatoria.">?</span>
            </label>
            <input type="number" name="seed" id="seed" placeholder="Ej: 12345" min="1" max="999999" value="{{ initial_seed }}">
        </div>

        <div class="form-group">
        <button type="submit" class="play-btn">
            üöÄ Aplicar Configuraci√≥n
        </button>
    </div>
    </div>
</form>

<div class="simulation-container">
    <div class="canvas-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">üó∫Ô∏è Mapa de Simulaci√≥n</h3>
            <div style="font-size: 0.9rem; color: var(--dark-gray);">
                <span id="statusIndicator" class="status-indicator status-stopped"></span>
                Estado: <span id="simulationStatus">Detenido</span>
            </div>
        </div>

        <canvas id="gridCanvas" width="600" height="400"></canvas>

        <div style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: var(--dark-gray);">
            üí° <strong>Tip:</strong> Haz clic en cualquier celda para ver informaci√≥n detallada
        </div>
    </div>

    <div class="controls-panel">
        <div class="controls-section">
            <h4>üéÆ Controles de Simulaci√≥n</h4>

            <div class="button-group">
                <button id="playButton" class="play-btn" title="Iniciar simulaci√≥n (Espacio)">
                    ‚ñ∂Ô∏è Iniciar
                </button>
                <button id="pauseButton" title="Pausar simulaci√≥n (Espacio)">
                    ‚è∏Ô∏è Pausar
                </button>
                <button id="resetButton" class="danger-btn" title="Reiniciar simulaci√≥n (R)">
                    üîÑ Reiniciar
                </button>
                <button id="stepButton" title="Avanzar un paso (S)">
                    ‚è≠Ô∏è Paso
                </button>
            </div>

            <div class="speed-control">
                <label for="speedSlider">
                    ‚ö° Velocidad de Simulaci√≥n
                    <span class="info-tooltip"
                        data-tooltip="Controla qu√© tan r√°pido avanza la simulaci√≥n. Mayor velocidad = menos tiempo entre pasos.">?</span>
                </label>
                <input type="range" id="speedSlider" class="speed-slider" min="1" max="200" value="100">
                <span id="speedValue" class="speed-value">1.0x</span>
            </div>

            <div style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="autoReset">
                    üîÑ Auto-reiniciar cuando no queden clanes
                </label>
            </div>
        </div>

        <div class="controls-section">
            <h4>üìä M√©tricas en Tiempo Real</h4>

            <div class="metrics">
                <div class="metric-item">
                    <span class="metric-label">üë• Poblaci√≥n Total:</span>
                    <span class="metric-value" id="population">0</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">üåø Recursos Totales:</span>
                    <span class="metric-value" id="totalResource">0.00</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">üéØ Modo:</span>
                    <span class="metric-value" id="modeDisplay">{{ current_mode }}</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">üî¢ Pasos:</span>
                    <span class="metric-value" id="stepCount">0</span>
                </div>

                <div class="metric-item">
                    <span class="metric-label">‚è±Ô∏è Tiempo:</span>
                    <span class="metric-value" id="timeElapsed">00:00</span>
                </div>
            </div>
        </div>

        <div class="controls-section">
            <h4>üèõÔ∏è Informaci√≥n de Clanes</h4>
            <div id="clanMetrics">
                <p style="text-align: center; color: var(--dark-gray); font-style: italic;">
                    Inicia la simulaci√≥n para ver estad√≠sticas de clanes
                </p>
            </div>
        </div>

        <div class="controls-section">
            <h4>‚ö° Acciones R√°pidas</h4>

            <button onclick="window.location.href='{{ url_for('conservation_analysis') }}'"
                style="width: 100%; margin-bottom: 0.5rem;">
                üî¨ An√°lisis de Conservaci√≥n
            </button>

            <button onclick="window.location.href='{{ url_for('convergence_analysis') }}'"
                style="width: 100%; margin-bottom: 0.5rem;">
                üìà An√°lisis de Convergencia
            </button>

            <button onclick="exportCurrentData()" style="width: 100%; margin-bottom: 0.5rem;">
                üíæ Exportar Datos Actuales
            </button>

            <button onclick="takeScreenshot()" style="width: 100%;">
                üì∏ Capturar Pantalla
            </button>
        </div>
    </div>
</div>


<div class="controls-section">
    <h4>‚èπÔ∏è Control de Finalizaci√≥n</h4>

    <div style="margin-bottom: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="autoReset" checked style="transform: scale(1.2);">
            üîÑ Auto-reiniciar cuando termine
        </label>
    </div>

    <div style="margin-bottom: 1rem;">
        <label for="maxStepsInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
            üìä M√°ximo de pasos:
        </label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="number" id="maxStepsInput" min="50" max="2000" value="500"
                style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="updateMaxSteps()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                ‚úÖ Aplicar
            </button>
        </div>
    </div>

    <div id="terminationInfo" style="font-size: 0.85rem; color: #666; line-height: 1.4;">
        <strong>Condiciones de finalizaci√≥n:</strong><br>
        ‚Ä¢ Extinci√≥n total (5 pasos sin poblaci√≥n)<br>
        ‚Ä¢ Un solo clan superviviente<br>
        ‚Ä¢ Poblaci√≥n cr√≠tica (‚â§5 individuos)<br>
        ‚Ä¢ Convergencia poblacional estable<br>
        ‚Ä¢ L√≠mite m√°ximo de pasos
    </div>
</div>

<div class="simulation-progress controls-section" style="display: none;">
    </div>

{# Comentado temporalmente el gr√°fico de Evoluci√≥n Temporal #}
{# <div class="chart-container">
    <h3>üìà Evoluci√≥n Temporal</h3>
    <canvas id="populationChart" width="800" height="300"></canvas>
</div> #}

<div class="analysis-section" style="margin-top: 2rem;">
    <h3>üìö Informaci√≥n del Sistema</h3>

    <div class="form-row">
        <div>
            <h4>üéØ Objetivo de la Simulaci√≥n</h4>
            <p>
                Esta simulaci√≥n modela la competencia territorial entre clanes que luchan por
                recursos limitados en un entorno compartido. Cada clan debe balancear el
                crecimiento poblacional con la sostenibilidad de los recursos disponibles.
            </p>
        </div>

        <div>
            <h4>üî¨ Par√°metros Clave</h4>
            <ul>
                <li><strong>Tama√±o del clan:</strong> Determina la capacidad de competencia</li>
                <li><strong>Recursos:</strong> Necesarios para la supervivencia y crecimiento</li>
                <li><strong>Territorio:</strong> √Årea de influencia y control</li>
                <li><strong>Interacciones:</strong> Competencia y colaboraci√≥n entre clanes</li>
            </ul>
        </div>

        <div>
            <h4>üé® Visualizaci√≥n</h4>
            <ul>
                <li><strong>Verde:</strong> Densidad de recursos (m√°s intenso = m√°s recursos)</li>
                <li><strong>C√≠rculos de colores:</strong> Clanes (tama√±o = poblaci√≥n)</li>
                <li><strong>√Åreas sombreadas:</strong> Influencia territorial</li>
                <li><strong>N√∫meros en clanes:</strong> Tama√±o actual de poblaci√≥n</li>
            </ul>
        </div>
    </div>
</div>


<div class="analysis-section">
    <h3>‚ö° Informaci√≥n de Rendimiento</h3>
    <div id="performanceInfo" style="font-family: monospace; font-size: 0.9rem;">
        <div>FPS: <span id="fps">--</span></div>
        <div>Latencia WebSocket: <span id="latency">--</span>ms</div>
        <div>Memoria utilizada: <span id="memoryUsage">--</span>MB</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
{# Comentado temporalmente el script de charts.js #}
{# <script src="{{ url_for('static', filename='js/charts.js') }}"></script> #}
<script>
    // Global utility function from base.html, ensure it's available
    function showNotification(message, type = 'info', duration = 3000) {
        console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
        `;
        const colors = {
            success: '#27ae60', error: '#e74c3c', warning: '#f39c12', info: '#3498db'
        };
        notification.style.backgroundColor = colors[type] || colors.info;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 100);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }

    // Existing updateMaxSteps function, now accessible globally (if needed from HTML button)
    function updateMaxSteps() {
        const input = document.getElementById('maxStepsInput');
        if (input && window.SimulationController) {
            const newMaxSteps = parseInt(input.value);
            if (newMaxSteps >= 50 && newMaxSteps <= 2000) {
                window.SimulationController.setMaxSteps(newMaxSteps);
                showNotification(`M√°ximo de pasos establecido en ${newMaxSteps}`, 'success');
            } else {
                showNotification('El m√°ximo de pasos debe estar entre 50 y 2000', 'error');
            }
        }
    }

    // Export current data function - moved to global scope
    window.exportCurrentData = function() {
        if (window.SimulationController && window.SimulationController.getState()) {
            const data = {
                state: window.SimulationController.getState(),
                history: {
                    // Ahora que el gr√°fico est√° comentado, esta historia no se usa para visualizaci√≥n inmediata,
                    // pero es bueno que siga siendo parte de la exportaci√≥n si hay datos disponibles.
                    population: window.SimulationController.getState().last_populations || [],
                    resources: window.SimulationController.getState().last_resources || []
                },
                timestamp: new Date().toISOString(),
                config: {
                    mode: document.getElementById('simulation_mode')?.value,
                    config_file: document.getElementById('config_file')?.value,
                    seed: document.getElementById('seed')?.value
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `simulation_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Datos exportados con √©xito!', 'success');
        } else {
            showNotification('No hay datos de simulaci√≥n disponibles para exportar.', 'error');
        }
    }

    // Take screenshot function - moved to global scope
    window.takeScreenshot = function() {
        const canvas = document.getElementById('gridCanvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `simulation_screenshot_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // Performance monitoring (existing, ensure it's still good)
    let fpsCounter = 0;
    let lastFpsTime = Date.now();

    function updatePerformanceInfo() {
        fpsCounter++;
        const now = Date.now();

        if (now - lastFpsTime >= 1000) {
            document.getElementById('fps').textContent = fpsCounter;
            fpsCounter = 0;
            lastFpsTime = now;
        }

        if (performance.memory) {
            const memUsed = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
            document.getElementById('memoryUsage').textContent = memUsed;
        }
        requestAnimationFrame(updatePerformanceInfo);
    }

    document.addEventListener('DOMContentLoaded', function () {
        updatePerformanceInfo();

        function updateSimulationStatus() {
            const statusDisplay = document.getElementById('simulationStatus');
            const isRunning = window.SimulationController ? window.SimulationController.isRunning() : false;
            if (statusDisplay) {
                statusDisplay.textContent = isRunning ? 'Ejecutando' : 'Detenido';
            }
        }
        setInterval(updateSimulationStatus, 1000);

        // Auto-save configuration
        document.getElementById('simulation_mode').addEventListener('change', function () {
            localStorage.setItem('sim_mode', this.value);
        });

        document.getElementById('config_file').addEventListener('change', function () {
            localStorage.setItem('sim_config', this.value);
        });

        // Restore saved configuration
        const savedMode = localStorage.getItem('sim_mode');
        const savedConfig = localStorage.getItem('sim_config');

        if (savedMode) {
            const modeSelect = document.getElementById('simulation_mode');
            if (modeSelect && modeSelect.querySelector(`option[value="${savedMode}"]`)) {
                modeSelect.value = savedMode;
            }
        }
        if (savedConfig) {
            const configSelect = document.getElementById('config_file');
            if (configSelect && configSelect.querySelector(`option[value="${savedConfig}"]`)) {
                configSelect.value = savedConfig;
            }
        }
    });
</script>
{% endblock %}